<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HANN 25 - ADMIN</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #050505; color: white; padding: 20px; min-height: 100vh; }
        .header-area { text-align: center; margin-bottom: 30px; margin-top: 10px; }
        .header-area h1 { letter-spacing: 2px; margin-bottom: 5px; font-size: 24px; }
        .header-area p { color: #666; font-size: 12px; margin-top: 0; }
        .card { background: #111; border: 1px solid #333; padding: 20px; border-radius: 15px; margin-bottom: 20px; max-width: 600px; margin-inline: auto; }
        h2 { color: #0ea5e9; font-size: 18px; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; }
        input, select { width: 100%; padding: 12px; background: #000; border: 1px solid #333; border-radius: 8px; color: white; margin-bottom: 10px; box-sizing: border-box; outline: none; }
        input:focus { border-color: #0ea5e9; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-blue { background: #0ea5e9; color: white; }
        .btn-blue:hover { background: #0284c7; }
        .btn-red { background: #ff4757; color: white; padding: 5px 10px; font-size: 11px; width: auto; border-radius: 5px; border: none; cursor: pointer; }
        .item { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #333; }
        .drag-handle { cursor: grab; margin-right: 12px; color: #0ea5e9; font-weight: bold; padding: 5px; }
        #main-content { display: none; }
    </style>
</head>
<body>
    <div id="main-content">
        <div class="header-area">
            <h1>MANAGER DASHBOARD</h1>
            <p>Update konten tanpa edit kode HTML</p>
        </div>

        <div class="card">
            <h2>üìë 1. Kelola Sidebar (Tarik ‚ò∞)</h2>
            <input type="text" id="side-icon" placeholder="Icon (üè†)">
            <input type="text" id="side-label" placeholder="Nama Menu">
            <input type="text" id="side-link" placeholder="Link Tujuan">
            <button class="btn btn-blue" onclick="window.addSidebar()">Tambah Menu</button>
            <div id="side-list" style="margin-top:20px;"></div>
        </div>

        <div class="card">
            <h2>üìÇ 2. Kelola Kategori (Tarik ‚ò∞)</h2>
            <input type="text" id="cat-name" placeholder="Nama Kategori Baru">
            <button class="btn btn-blue" onclick="window.addCategory()">Tambah Kategori</button>
            <div id="cat-list" style="margin-top:20px;"></div>
        </div>

        <div class="card">
            <h2>üîò 3. Tambah Tombol</h2>
            <select class="cat-select-sync" id="target-cat-add"></select>
            <input type="text" id="btn-icon" placeholder="Icon (Emoji/Link)">
            <input type="text" id="btn-label" placeholder="Nama Tombol">
            <input type="text" id="btn-link" placeholder="Link (https://...)">
            <button class="btn btn-blue" onclick="window.addButton()">Simpan Tombol</button>
        </div>

        <div class="card">
            <h2>üóëÔ∏è 4. Urutkan & Hapus Tombol (Tarik ‚ò∞)</h2>
            <select class="cat-select-sync" id="target-cat-manage" onchange="window.loadButtons(this.value)"></select>
            <div id="manage-btn-list" style="margin-top:20px;"></div>
        </div>

        <div class="card">
            <h2>‚≠ê 5. Kelola Testimoni</h2>
            <p id="testi-count" style="font-size: 11px; color: #0ea5e9;">Loading...</p>
            <div id="testi-admin-list" style="margin-top:20px; max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove, update, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getRemoteConfig, getValue, fetchAndActivate } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-remote-config.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBgqJ0f2v88T6Ijamd5gGS-NZzJyVl0pYU",
            authDomain: "adminhann25.firebaseapp.com",
            projectId: "adminhann25",
            databaseURL: "https://adminhann25-default-rtdb.asia-southeast1.firebasedatabase.app",
            appId: "1:1020946488981:web:9b2cf0902f5665e342c59c"
        };

        const testiConfig = {
            apiKey: "AIzaSyALjgltMZpaRvsXnPywGXx-EcPLTHlt5ME",
            databaseURL: "https://testimonihann25-default-rtdb.asia-southeast1.firebasedatabase.app",
            appId: "1:222002513476:web:46249257e0520268579d46"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const appT = initializeApp(testiConfig, "testiApp");
        const dbT = getDatabase(appT);
        const rc = getRemoteConfig(app);
        rc.settings.minimumFetchIntervalMillis = 0;

        let isDragging = false;
        let curCid = null;
        const elS = document.getElementById('side-list'), elC = document.getElementById('cat-list'), elB = document.getElementById('manage-btn-list');

        const checkAccess = async () => {
            if (sessionStorage.getItem("__auth") === "true") {
                document.getElementById("main-content").style.display = "block";
                return;
            }
            try {
                await fetchAndActivate(rc);
                const pass = getValue(rc, "admin_password").asString();
                const { value: res } = await Swal.fire({
                    title: 'ADMIN ACCESS', input: 'password', background: '#111', color: '#fff',
                    allowOutsideClick: false, preConfirm: (v) => v === pass || Swal.showValidationMessage('Salah!')
                });
                if (res) {
                    sessionStorage.setItem("__auth", "true");
                    document.getElementById("main-content").style.display = "block";
                }
            } catch (err) { console.error(err); }
        };

        const saveNewOrder = async (el, path) => {
            const updates = {};
            el.querySelectorAll('.item').forEach((item, index) => {
                updates[`${path}/${item.dataset.id}/order`] = index;
            });
            await update(ref(db), updates);
            Swal.fire({ title: 'Urutan Disimpan', icon: 'success', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
            setTimeout(() => { isDragging = false; }, 500);
        };

        Sortable.create(elS, { handle: '.drag-handle', animation: 150, onStart: () => isDragging = true, onEnd: () => saveNewOrder(elS, 'dashboard/sidebar') });
        Sortable.create(elC, { handle: '.drag-handle', animation: 150, onStart: () => isDragging = true, onEnd: () => saveNewOrder(elC, 'dashboard/categories') });
        Sortable.create(elB, { handle: '.drag-handle', animation: 150, onStart: () => isDragging = true, onEnd: () => curCid && saveNewOrder(elB, `dashboard/categories/${curCid}/buttons`) });

        onValue(query(ref(db, 'dashboard/sidebar'), orderByChild('order')), (s) => {
            if (isDragging) return;
            elS.innerHTML = "";
            s.forEach(c => {
                const d = document.createElement('div'); d.className = 'item'; d.dataset.id = c.key;
                d.innerHTML = `<div style="display:flex;align-items:center;"><span class="drag-handle">‚ò∞</span>${c.val().icon} <b>${c.val().label}</b></div><button class="btn-red" onclick="window.delData('dashboard/sidebar/${c.key}')">Hapus</button>`;
                elS.appendChild(d);
            });
        });

        onValue(query(ref(db, 'dashboard/categories'), orderByChild('order')), (s) => {
            if (isDragging) return;
            elC.innerHTML = "";
            let opts = '<option value="">-- Pilih Kategori --</option>';
            s.forEach(c => {
                const d = document.createElement('div'); d.className = 'item'; d.dataset.id = c.key;
                d.innerHTML = `<div style="display:flex;align-items:center;"><span class="drag-handle">‚ò∞</span><b>${c.val().name}</b></div><button class="btn-red" onclick="window.delData('dashboard/categories/${c.key}')">Hapus</button>`;
                elC.appendChild(d);
                opts += `<option value="${c.key}">${c.val().name}</option>`;
            });
            document.querySelectorAll('.cat-select-sync').forEach(sel => {
                const currentVal = sel.value;
                sel.innerHTML = opts;
                if(currentVal) sel.value = currentVal;
            });
        });

        window.loadButtons = (cid) => {
            curCid = cid;
            if(!cid) return elB.innerHTML = "";
            onValue(query(ref(db, `dashboard/categories/${cid}/buttons`), orderByChild('order')), (s) => {
                if (isDragging) return;
                elB.innerHTML = "";
                s.forEach(c => {
                    const d = document.createElement('div'); d.className = 'item'; d.dataset.id = c.key;
                    d.innerHTML = `<div style="display:flex;align-items:center;"><span class="drag-handle">‚ò∞</span>${c.val().label}</div><button class="btn-red" onclick="window.delData('dashboard/categories/${curCid}/buttons/${c.key}')">Hapus</button>`;
                    elB.appendChild(d);
                });
            });
        };

        window.addSidebar = () => {
            const i = document.getElementById('side-icon').value || 'üìç', l = document.getElementById('side-label').value, u = document.getElementById('side-link').value;
            if(l && u) {
                push(ref(db, 'dashboard/sidebar'), { icon: i, label: l, link: u, order: Date.now() });
                document.querySelectorAll('#side-icon, #side-label, #side-link').forEach(x => x.value = "");
            }
        };

        window.addCategory = () => {
            const n = document.getElementById('cat-name').value;
            if(n) {
                push(ref(db, 'dashboard/categories'), { name: n.toUpperCase(), order: Date.now() });
                document.getElementById('cat-name').value = "";
            }
        };

        window.addButton = () => {
            const cid = document.getElementById('target-cat-add').value, l = document.getElementById('btn-label').value, u = document.getElementById('btn-link').value, i = document.getElementById('btn-icon').value || 'üîó';
            if(cid && l && u) {
                push(ref(db, `dashboard/categories/${cid}/buttons`), { icon: i, label: l, link: u, order: Date.now() });
                document.querySelectorAll('#btn-icon, #btn-label, #btn-link').forEach(x => x.value = "");
            }
        };

        window.delData = (p) => Swal.fire({title:"Hapus?", icon:"warning", showCancelButton:true}).then(r => r.isConfirmed && remove(ref(db, p)));

        onValue(ref(dbT, 'testimonies'), (s) => {
            const l = document.getElementById('testi-admin-list'); l.innerHTML = "";
            let a = []; 
            if(s.exists()) {
                s.forEach(c => a.push({id: c.key, ...c.val()}));
                a.sort((x,y) => y.ts - x.ts);
                document.getElementById('testi-count').innerText = `${a.length} Testimoni`;
                a.forEach(t => {
                    const p = t.photo === 'default' ? 'https://i.ibb.co.com/pBn06NLp/user.png' : t.photo;
                    l.innerHTML += `<div class="item" style="flex-direction:column;align-items:start;"><div style="display:flex;align-items:center;gap:10px;width:100%;"><img src="${p}" style="width:30px;height:30px;border-radius:50%;"><div style="flex:1;"><b>${t.name}</b></div><button class="btn-red" onclick="window.delTesti('${t.id}')">Hapus</button></div></div>`;
                });
            }
        });

        window.delTesti = (id) => Swal.fire({title:"Hapus?", icon:"warning", showCancelButton:true}).then(r => r.isConfirmed && remove(ref(dbT, `testimonies/${id}`)));

        checkAccess();
    </script>
</body>
</html>
